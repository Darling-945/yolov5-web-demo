{% extends 'base.html' %}

{% block content %}
<div class="main-container fade-in">
  <!-- 标题区域 -->
  <div class="text-center mb-4 mb-md-5">
    <div class="mb-3 mb-md-4">
      <i class="fas fa-eye fa-3x fa-md-4x mb-3 mb-md-4 float-animation" style="color: var(--primary-color);"></i>
    </div>
    <h1 class="display-4 fw-bold">智能目标检测</h1>
    <p class="lead text-muted fs-5 d-none d-md-block">上传图片，使用先进的YOLO技术检测目标</p>
    <p class="text-muted fs-6 d-md-none">上传图片进行目标检测</p>
  </div>

  <!-- 上传区域 -->
  <div class="upload-container mb-3 mb-md-4">
    <form action="/infer" method="POST" enctype="multipart/form-data" id="uploadForm">
      <div class="mb-3 mb-md-4">
        <div class="row justify-content-center">
          <div class="col-12 col-lg-10 col-xl-8">
            <div class="upload-area w-100 mx-auto" id="uploadArea">
              <i class="fas fa-cloud-upload-alt fa-2x fa-md-3x mb-3 mb-md-4" style="color: var(--primary-color);"></i>
              <h4 class="mb-3 mb-md-4 fw-semibold h6 h-md-5">拖拽图片到此处</h4>
              <p class="text-muted mb-3 mb-md-4">或</p>
              <input type="file" name="file" accept=".jpg, .jpeg, .png, .webp" class="form-control d-none" id="fileInput" required>
              <button type="button" class="btn btn-outline-primary btn-sm px-4 py-2" id="selectFileBtn">
                <i class="fas fa-folder-open me-2"></i>
                <span class="d-none d-md-inline">点击选择文件</span>
                <span class="d-md-none">选择文件</span>
              </button>
              <p class="text-muted mt-3 small mb-0">支持 JPG, JPEG, PNG, WEBP 格式</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 预览区域 -->
      <div id="previewContainer" class="text-center mb-3 mb-md-4" style="display: none;">
        <h5 class="mb-2 mb-md-3 fw-semibold h6">图片预览</h5>
        <div class="d-flex justify-content-center">
          <img id="previewImage" class="img-fluid rounded-3 shadow-lg" style="max-height: 180px; max-width: 100%; border: 3px solid var(--primary-color);">
        </div>
      </div>

      <!-- 模型配置 -->
      <div class="row justify-content-center mb-3 mb-md-4">
        <div class="col-12 col-lg-10 col-xl-8">
          <div class="card">
            <div class="card-body p-3 p-md-4">
              <h5 class="card-title text-center mb-3 mb-md-4 fw-semibold h6 h-md-5">
                <i class="fas fa-cog me-2"></i>检测配置
              </h5>
              <div class="row g-3 g-md-4 justify-content-center">
                <div class="col-12">
                  <label for="modelSelect" class="form-label fw-semibold small text-center">
                    <i class="fas fa-robot me-2"></i>选择模型
                  </label>
                  <select class="form-select form-select-sm mx-auto" id="modelSelect" name="model" style="max-width: 400px;">
                    <optgroup label="YOLOv11 系列">
                      <option value="yolo11n.pt">YOLOv11 Nano (最快)</option>
                      <option value="yolo11s.pt">YOLOv11 Small</option>
                      <option value="yolo11m.pt">YOLOv11 Medium</option>
                      <option value="yolo11l.pt">YOLOv11 Large</option>
                      <option value="yolo11x.pt">YOLOv11 Extra Large (最准确)</option>
                    </optgroup>
                    <optgroup label="YOLOv8 系列">
                      <option value="yolov8n.pt">YOLOv8 Nano</option>
                      <option value="yolov8s.pt">YOLOv8 Small</option>
                      <option value="yolov8m.pt">YOLOv8 Medium</option>
                      <option value="yolov8l.pt">YOLOv8 Large</option>
                      <option value="yolov8x.pt">YOLOv8 Extra Large</option>
                    </optgroup>
                    <optgroup label="YOLOv5 系列">
                      <option value="yolov5n.pt">YOLOv5 Nano</option>
                      <option value="yolov5s.pt">YOLOv5 Small</option>
                      <option value="yolov5m.pt">YOLOv5 Medium</option>
                      <option value="yolov5l.pt">YOLOv5 Large</option>
                      <option value="yolov5x.pt">YOLOv5 Extra Large</option>
                    </optgroup>
                    <optgroup label="自定义模型" id="customModelsGroup" style="display: none;">
                      <!-- 自定义模型将通过JavaScript动态添加 -->
                    </optgroup>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <div class="text-center">
                    <label for="confidenceSlider" class="form-label fw-semibold small">
                      <i class="fas fa-bullseye me-2"></i>置信度阈值
                    </label>
                    <div class="d-flex flex-column align-items-center gap-2">
                      <input type="range" class="form-range w-100" style="max-width: 200px;" id="confidenceSlider" min="0.1" max="0.9" step="0.05" value="0.25">
                      <div class="d-flex align-items-center gap-2">
                        <input type="number" class="form-control form-control-sm text-center" id="confidenceInput" min="0.1" max="0.9" step="0.05" value="0.25" style="width: 80px;">
                        <span class="badge bg-primary px-2 py-1" id="confidenceValue">0.25</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="text-center">
                    <label for="iouSlider" class="form-label fw-semibold small">
                      <i class="fas fa-vector-square me-2"></i>IOU阈值
                    </label>
                    <div class="d-flex flex-column align-items-center gap-2">
                      <input type="range" class="form-range w-100" style="max-width: 200px;" id="iouSlider" min="0.1" max="0.9" step="0.05" value="0.45">
                      <div class="d-flex align-items-center gap-2">
                        <input type="number" class="form-control form-control-sm text-center" id="iouInput" min="0.1" max="0.9" step="0.05" value="0.45" style="width: 80px;">
                        <span class="badge bg-success px-2 py-1" id="iouValue">0.45</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 检测按钮 -->
      <div class="text-center">
        <button type="submit" class="btn btn-primary px-4 px-md-5 py-2 py-md-3 position-relative w-100 w-md-auto" id="uploadBtn" disabled>
          <span id="uploadBtnText">
            <i class="fas fa-search me-2"></i>
            <span class="d-none d-md-inline">开始检测</span>
            <span class="d-md-none">检测</span>
          </span>
          <div class="loading-spinner ms-2" id="uploadSpinner"></div>
          <div class="ripple-effect"></div>
        </button>
      </div>
    </form>
  </div>

  <!-- 特性展示 -->
  <div class="card mx-auto mt-4" style="max-width: 900px;">
    <div class="card-body p-3 p-md-4">
      <div class="text-center mb-3">
        <h3 class="fw-bold h5 h-md-4">核心特性</h3>
        <p class="text-muted small d-none d-md-block">体验先进的目标检测技术</p>
      </div>
      <div class="row g-3 justify-content-center">
        <div class="col-12 col-md-4">
          <div class="text-center">
            <div class="feature-icon mx-auto mb-2" style="width: 50px; height: 50px; font-size: 1.2rem;">
              <i class="fas fa-bolt"></i>
            </div>
            <h6 class="fw-semibold mb-1">实时检测</h6>
            <p class="text-muted small mb-0">基于YOLO算法的快速准确目标检测</p>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="text-center">
            <div class="feature-icon mx-auto mb-2" style="width: 50px; height: 50px; font-size: 1.2rem;">
              <i class="fas fa-cogs"></i>
            </div>
            <h6 class="fw-semibold mb-1">多模型支持</h6>
            <p class="text-muted small mb-0">支持YOLOv5/v8/v11及自定义模型</p>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="text-center">
            <div class="feature-icon mx-auto mb-2" style="width: 50px; height: 50px; font-size: 1.2rem;">
              <i class="fas fa-sliders-h"></i>
            </div>
            <h6 class="fw-semibold mb-1">灵活配置</h6>
            <p class="text-muted small mb-0">可调节置信度阈值和模型选择</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 页面加载时获取自定义模型
document.addEventListener('DOMContentLoaded', function() {
    loadCustomModels();

    // 卡片动画
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in');
    });
});

// 加载自定义模型
async function loadCustomModels() {
    try {
        const response = await fetch('/api/models');
        const data = await response.json();

        if (data.custom_models && data.custom_models.length > 0) {
            const customGroup = document.getElementById('customModelsGroup');
            customGroup.style.display = 'block';

            // 清空现有自定义模型选项
            customGroup.innerHTML = '';

            // 添加自定义模型选项
            data.custom_models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model.replace('.pt', '') + ' (自定义)';
                customGroup.appendChild(option);
            });
        }
    } catch (error) {
        console.log('无法加载自定义模型:', error);
    }
}

// 文件输入处理
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // 启用上传按钮
        document.getElementById('uploadBtn').disabled = false;

        // 显示预览
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImg = document.getElementById('previewImage');
            previewImg.src = e.target.result;
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('previewContainer').classList.add('fade-in');
        };
        reader.readAsDataURL(file);
    }
});

// 置信度双模式处理
function setupConfidenceControls() {
    const slider = document.getElementById('confidenceSlider');
    const input = document.getElementById('confidenceInput');
    const badge = document.getElementById('confidenceValue');

    // 滑块变化时更新输入框和标签
    slider.addEventListener('input', function(e) {
        const value = parseFloat(e.target.value);
        input.value = value;
        badge.textContent = value;
    });

    // 输入框变化时更新滑块和标签
    input.addEventListener('input', function(e) {
        let value = parseFloat(e.target.value);

        // 验证输入值范围
        if (isNaN(value)) value = 0.25;
        if (value < 0.1) value = 0.1;
        if (value > 0.9) value = 0.9;

        // 四舍五入到步长的精度
        value = Math.round(value / 0.05) * 0.05;

        input.value = value;
        slider.value = value;
        badge.textContent = value;
    });

    // 输入框失去焦点时验证格式
    input.addEventListener('blur', function(e) {
        let value = parseFloat(e.target.value);
        if (isNaN(value) || value < 0.1 || value > 0.9) {
            value = 0.25;
            input.value = value;
            slider.value = value;
            badge.textContent = value;
        }
    });
}

// IOU双模式处理
function setupIOUControls() {
    const slider = document.getElementById('iouSlider');
    const input = document.getElementById('iouInput');
    const badge = document.getElementById('iouValue');

    // 滑块变化时更新输入框和标签
    slider.addEventListener('input', function(e) {
        const value = parseFloat(e.target.value);
        input.value = value;
        badge.textContent = value;
    });

    // 输入框变化时更新滑块和标签
    input.addEventListener('input', function(e) {
        let value = parseFloat(e.target.value);

        // 验证输入值范围
        if (isNaN(value)) value = 0.45;
        if (value < 0.1) value = 0.1;
        if (value > 0.9) value = 0.9;

        // 四舍五入到步长的精度
        value = Math.round(value / 0.05) * 0.05;

        input.value = value;
        slider.value = value;
        badge.textContent = value;
    });

    // 输入框失去焦点时验证格式
    input.addEventListener('blur', function(e) {
        let value = parseFloat(e.target.value);
        if (isNaN(value) || value < 0.1 || value > 0.9) {
            value = 0.45;
            input.value = value;
            slider.value = value;
            badge.textContent = value;
        }
    });
}

// 初始化控件
document.addEventListener('DOMContentLoaded', function() {
    setupConfidenceControls();
    setupIOUControls();
});

// 表单提交处理
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const uploadSpinner = document.getElementById('uploadSpinner');

    // 显示加载状态
    uploadBtn.disabled = true;
    uploadBtnText.style.display = 'none';
    uploadSpinner.style.display = 'inline-block';

    // 添加波纹效果
    createRipple(e);

    // 显示Toast通知
    showToast('info', '正在上传图片并进行检测...', 'info');

    // 获取配置参数
    const model = document.getElementById('modelSelect').value;
    const confidence = document.getElementById('confidenceInput').value;
    const iou = document.getElementById('iouInput').value;

    // 创建隐藏输入字段
    let modelInput = document.createElement('input');
    modelInput.type = 'hidden';
    modelInput.name = 'model';
    modelInput.value = model;
    this.appendChild(modelInput);

    let confidenceInput = document.createElement('input');
    confidenceInput.type = 'hidden';
    confidenceInput.name = 'confidence';
    confidenceInput.value = confidence;
    this.appendChild(confidenceInput);

    let iouInput = document.createElement('input');
    iouInput.type = 'hidden';
    iouInput.name = 'iou';
    iouInput.value = iou;
    this.appendChild(iouInput);
});

// 创建波纹效果
function createRipple(e) {
    const button = e.currentTarget;
    const ripple = document.createElement('span');
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = e.clientX - rect.left - size / 2;
    const y = e.clientY - rect.top - size / 2;

    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    ripple.classList.add('ripple-effect');

    button.appendChild(ripple);

    setTimeout(() => {
        ripple.remove();
    }, 600);
}

// 为按钮添加波纹效果
document.getElementById('uploadBtn').addEventListener('click', createRipple);

// 文件拖拽增强
uploadArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();

    const dt = e.dataTransfer;
    const files = dt.files;

    // 验证拖拽的文件
    if (files.length === 0) {
        showToast('error', '没有检测到文件', 'error');
        return;
    }

    const file = files[0];

    // 处理文件
    if (handleFile(file)) {
        // 设置文件输入框的值（保留用于表单提交）
        const fileInput = document.getElementById('fileInput');
        fileInput.files = files;

        // 显示成功提示
        showToast('success', `已添加文件: ${file.name}`, 'success');
    }
}

// 键盘快捷键支持
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter 快速上传
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        if (!document.getElementById('uploadBtn').disabled) {
            document.getElementById('uploadForm').dispatchEvent(new Event('submit'));
        }
    }

    // Ctrl+O 打开文件选择
    if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
        e.preventDefault();
        document.getElementById('fileInput').click();
    }
});

// 文件处理函数（用于拖拽上传）
function handleFile(file) {
    if (!file) {
        return false;
    }

    // 验证文件类型
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showToast('error', '不支持的文件类型，请选择 JPG、PNG 或 WEBP 图片', 'error');
        return false;
    }

    // 验证文件大小 (最大10MB)
    if (file.size > 10 * 1024 * 1024) {
        showToast('error', '文件大小不能超过 10MB', 'error');
        return false;
    }

    // 启用上传按钮
    document.getElementById('uploadBtn').disabled = false;

    // 显示预览
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImg = document.getElementById('previewImage');
        previewImg.src = e.target.result;
        document.getElementById('previewContainer').style.display = 'block';
        document.getElementById('previewContainer').classList.add('fade-in');
        showToast('success', '图片已成功加载', 'success');
    };
    reader.readAsDataURL(file);

    return true;
}

// 页面加载完成后添加增强功能
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，初始化事件监听器...');

    // 添加文件验证提示
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.setAttribute('title', '支持 JPG、PNG、WEBP 格式，最大 10MB');

        // 文件输入变化事件
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                console.log('文件输入变化事件触发');
                handleFile(file);
            }
        });

        console.log('文件输入框初始化完成');
    } else {
        console.error('找不到文件输入框');
    }

    // 为选择按钮添加提示和事件监听器
    const selectBtn = document.getElementById('selectFileBtn');
    if (selectBtn) {
        selectBtn.setAttribute('title', '点击选择图片文件 (Ctrl+O)');

        // 文件选择按钮点击事件
        selectBtn.addEventListener('click', function(e) {
            console.log('文件选择按钮被点击');
            e.preventDefault();
            e.stopPropagation();
            fileInput.click();
        });

        console.log('文件选择按钮初始化完成');
    } else {
        console.error('找不到文件选择按钮');
    }

    // 模型选择增强
    const modelSelect = document.getElementById('modelSelect');
    if (modelSelect) {
        modelSelect.addEventListener('change', function(e) {
            const modelText = e.target.options[e.target.selectedIndex].text;
            showToast('info', `已选择模型: ${modelText}`, 'info');
        });
        console.log('模型选择器初始化完成');
    } else {
        console.error('找不到模型选择器');
    }

    console.log('所有事件监听器初始化完成');
});

// 拖拽上传功能
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// 防止页面级别的拖拽事件
document.addEventListener('dragover', function(e) {
    e.preventDefault();
});

document.addEventListener('drop', function(e) {
    e.preventDefault();
});

['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    uploadArea.classList.add('dragover');
}

function unhighlight(e) {
    uploadArea.classList.remove('dragover');
}

uploadArea.addEventListener('drop', handleDrop, false);

</script>
{% endblock %}