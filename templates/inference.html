{% extends 'base.html' %}

{% block content %}
<div class="main-container fade-in">
    <!-- 标题区域 -->
    <div class="text-center mb-6">
        <div class="mb-4">
            <i class="fas fa-chart-bar fa-4x mb-4 float-animation" style="color: var(--primary-color);"></i>
        </div>
        <h1 class="display-4 fw-bold">检测结果</h1>
        <p class="lead text-muted fs-5">原始图片与检测结果的对比</p>
    </div>

    <!-- 图片对比区域 -->
    <div class="row g-3 g-md-4 g-lg-5 justify-content-center mb-4 mb-md-6">
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header text-center py-3 py-md-4">
                    <h5 class="card-title mb-0 fw-semibold h6 h-md-5">
                        <i class="fas fa-image me-2" style="color: var(--primary-color);"></i>
                        <span class="d-none d-md-inline">原始图片</span>
                        <span class="d-md-none">原图</span>
                    </h5>
                </div>
                <div class="card-body text-center p-3 p-md-4">
                    <div class="image-container position-relative">
                        <img src="{{ saveLocation }}" class="img-fluid rounded-3 shadow-lg" alt="原始图片" style="max-height: 250px; object-fit: contain; border: 3px solid rgba(102, 126, 234, 0.2);">
                        <div class="image-overlay">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewFullscreen('{{ saveLocation }}')">
                                <i class="fas fa-expand"></i>
                                <span class="d-none d-md-inline">全屏查看</span>
                                <span class="d-md-none">全屏</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header text-center py-3 py-md-4">
                    <h5 class="card-title mb-0 fw-semibold h6 h-md-5">
                        <i class="fas fa-search me-2" style="color: var(--success-color);"></i>
                        <span class="d-none d-md-inline">检测结果</span>
                        <span class="d-md-none">结果</span>
                    </h5>
                </div>
                <div class="card-body text-center p-3 p-md-4">
                    <div class="image-container position-relative">
                        <img src="{{ output_image }}" class="img-fluid rounded-3 shadow-lg" alt="检测结果" style="max-height: 250px; object-fit: contain; border: 3px solid rgba(40, 167, 69, 0.2);">
                        <div class="image-overlay">
                            <button class="btn btn-outline-success btn-sm" onclick="viewFullscreen('{{ output_image }}')">
                                <i class="fas fa-expand"></i>
                                <span class="d-none d-md-inline">全屏查看</span>
                                <span class="d-md-none">全屏</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if result %}
    <!-- 检测结果统计 -->
    <div class="row justify-content-center mb-6">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header text-center py-4" style="background: var(--bg-gradient); color: white;">
                    <h4 class="card-title mb-0 fw-bold">
                        <i class="fas fa-chart-bar me-2"></i>检测结果统计
                    </h4>
                </div>
                <div class="card-body p-5">
                    <div class="row g-5">
                        <!-- 检测摘要 -->
                        <div class="col-md-6">
                            <h5 class="fw-semibold mb-4 text-center">检测摘要</h5>
                            <div class="alert alert-info text-center py-3 rounded-3">
                                <h6 class="fw-bold">检测到的目标总数</h6>
                                <div class="display-6 fw-bold text-primary">{{ result.summary.total_detections }}</div>
                            </div>
                            {% if result.summary.detection_summary %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-center">目标类型</th>
                                            <th class="text-center">数量</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for class_name, count in result.summary.detection_summary.items() %}
                                        <tr>
                                            <td class="text-center fw-semibold">{{ class_name }}</td>
                                            <td class="text-center">
                                                <span class="badge bg-primary fs-6 px-3 py-2">{{ count }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-warning text-center py-4 rounded-3">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <p class="mb-0">在当前置信度阈值下未检测到目标</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- 检测详情 -->
                        <div class="col-md-6">
                            <h5 class="fw-semibold mb-4 text-center">检测详情</h5>
                            {% if result.detections %}
                            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-center">目标</th>
                                            <th class="text-center">置信度</th>
                                            <th class="text-center">边界框</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for detection in result.detections %}
                                        <tr>
                                            <td class="text-center">
                                                <span class="badge bg-info fs-6 px-3 py-2">{{ detection.class_name }}</span>
                                            </td>
                                            <td class="text-center">
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-3" style="height: 24px;">
                                                        <div class="progress-bar {% if detection.confidence > 0.7 %}bg-success{% elif detection.confidence > 0.4 %}bg-warning{% else %}bg-danger{% endif %}"
                                                             role="progressbar"
                                                             style="width: {{ detection.confidence * 100 }}%"
                                                             aria-valuenow="{{ detection.confidence * 100 }}"
                                                             aria-valuemin="0"
                                                             aria-valuemax="100">
                                                        </div>
                                                    </div>
                                                    <span class="fw-bold text-nowrap">{{ "%.1f"|format(detection.confidence * 100) }}%</span>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <small class="text-muted">
                                                    [{{ "%.0f"|format(detection.bbox[0]) }}, {{ "%.0f"|format(detection.bbox[1]) }},
                                                     {{ "%.0f"|format(detection.bbox[2]) }}, {{ "%.0f"|format(detection.bbox[3]) }}]
                                                </small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-warning text-center py-4 rounded-3">
                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                <p class="mb-0">暂无详细检测信息</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 操作按钮 -->
    <div class="text-center mb-4 mb-md-6">
        <div class="btn-group d-flex flex-column flex-md-row gap-2 gap-md-0" role="group">
            <a href="/" class="btn btn-primary px-4 px-md-5 py-2 py-md-3 flex-fill flex-md-auto">
                <i class="fas fa-upload me-2"></i>
                <span class="d-none d-md-inline">上传新图片</span>
                <span class="d-md-none">新图片</span>
            </a>
            <button class="btn btn-outline-secondary px-3 px-md-4 py-2 py-md-3 flex-fill flex-md-auto" onclick="downloadImage('{{ output_image }}')">
                <i class="fas fa-download me-2"></i>
                <span class="d-none d-md-inline">下载结果</span>
                <span class="d-md-none">下载</span>
            </button>
            <button class="btn btn-outline-info px-3 px-md-4 py-2 py-md-3 flex-fill flex-md-auto" onclick="shareResults()">
                <i class="fas fa-share-alt me-2"></i>
                <span class="d-none d-md-inline">分享结果</span>
                <span class="d-md-none">分享</span>
            </button>
        </div>
        <div class="mt-2 mt-md-3 d-none d-lg-block">
            <small class="text-muted">
                <i class="fas fa-keyboard me-1"></i>
                按 <kbd>Esc</kbd> 返回首页 | <kbd>Ctrl+S</kbd> 保存结果
            </small>
        </div>
    </div>

    <!-- 技术说明 -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card bg-light">
                <div class="card-body p-5">
                    <h5 class="card-title text-center fw-bold mb-4">
                        <i class="fas fa-info-circle me-2" style="color: var(--primary-color);"></i>关于YOLO目标检测
                    </h5>
                    <p class="card-text text-center mb-4">YOLO (You Only Look Once) 是一种先进的实时目标检测系统，它将图像划分为网格，并同时预测边界框和类别概率。</p>
                    <div class="row g-4 text-center">
                        <div class="col-md-4">
                            <div class="feature-icon mx-auto mb-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <h6 class="fw-semibold">快速</h6>
                            <p class="small text-muted">实时处理图像，具有高精度</p>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-icon mx-auto mb-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-cubes"></i>
                            </div>
                            <h6 class="fw-semibold">准确</h6>
                            <p class="small text-muted">在单次前向传递中检测多个目标</p>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-icon mx-auto mb-3" style="width: 60px; height: 60px;">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <h6 class="fw-semibold">鲁棒</h6>
                            <p class="small text-muted">适用于各种目标尺寸和位置</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 增强的结果页面功能
document.addEventListener('DOMContentLoaded', function() {
    // 图片加载状态处理
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        // 添加加载动画
        img.classList.add('loading');

        img.addEventListener('load', function() {
            this.classList.remove('loading');
            this.classList.add('loaded');

            // 显示加载完成通知
            if (img.alt === '检测结果') {
                showToast('success', '检测结果图片已加载完成', 'success');
            }
        });

        img.addEventListener('error', function() {
            this.classList.remove('loading');
            this.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22640%22%20height%3D%22350%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%23f8f9fa%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20fill%3D%22%236c757d%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214px%22%3EImage%20could%20not%20be%20loaded%3C%2Ftext%3E%3C%2Fsvg%3E';
            this.alt = 'Image not available';
            showToast('error', '图片加载失败', 'error');
        });
    });

    // 显示检测统计动画
    const statsCards = document.querySelectorAll('.card');
    statsCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';

        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 200 + index * 150);
    });

    // 添加结果统计的数字动画
    animateCounters();
});

// 数字计数动画
function animateCounters() {
    const totalDetections = document.querySelector('.display-6');
    if (totalDetections) {
        const target = parseInt(totalDetections.textContent);
        let current = 0;
        const increment = target / 50;
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            totalDetections.textContent = Math.floor(current);
        }, 30);
    }
}

// 全屏查看图片
function viewFullscreen(imageSrc) {
    const modal = document.createElement('div');
    modal.className = 'fullscreen-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;

    const img = document.createElement('img');
    img.src = imageSrc;
    img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    `;

    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '<i class="fas fa-times"></i>';
    closeBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        font-size: 1.5rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.3s ease;
    `;

    closeBtn.addEventListener('click', () => closeModal());
    modal.addEventListener('click', () => closeModal());

    modal.appendChild(img);
    modal.appendChild(closeBtn);
    document.body.appendChild(modal);

    // 触发动画
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);

    function closeModal() {
        modal.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(modal);
        }, 300);
    }

    // ESC 键关闭
    const handleEsc = (e) => {
        if (e.key === 'Escape') {
            closeModal();
            document.removeEventListener('keydown', handleEsc);
        }
    };
    document.addEventListener('keydown', handleEsc);
}

// 下载图片
function downloadImage(imageSrc) {
    const link = document.createElement('a');
    link.href = imageSrc;
    link.download = `yolo_detection_result_${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('success', '检测结果已开始下载', 'success');
}

// 分享结果
function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'YOLO 目标检测结果',
            text: '查看我的YOLO目标检测结果！',
            url: window.location.href
        }).then(() => {
            showToast('success', '分享成功', 'success');
        }).catch((error) => {
            console.log('分享失败:', error);
        });
    } else {
        // 复制链接到剪贴板
        navigator.clipboard.writeText(window.location.href).then(() => {
            showToast('success', '链接已复制到剪贴板', 'success');
        });
    }
}

// 键盘快捷键
document.addEventListener('keydown', function(e) {
    // Esc 返回首页
    if (e.key === 'Escape') {
        window.location.href = '/';
    }

    // Ctrl+S 保存结果
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        downloadImage('{{ output_image }}');
    }

    // F 全屏查看第一张图片
    if (e.key === 'f' || e.key === 'F') {
        viewFullscreen('{{ output_image }}');
    }
});

// 添加图片悬浮效果
document.querySelectorAll('.image-container').forEach(container => {
    container.addEventListener('mouseenter', function() {
        this.querySelector('.image-overlay').style.opacity = '1';
    });

    container.addEventListener('mouseleave', function() {
        this.querySelector('.image-overlay').style.opacity = '0';
    });
});
</script>

<style>
/* 图片容器样式 */
.image-container {
    position: relative;
    overflow: hidden;
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 12px;
}

/* 图片加载动画 */
img.loading {
    filter: blur(5px);
    opacity: 0.7;
}

img.loaded {
    filter: none;
    opacity: 1;
    transition: all 0.3s ease;
}

/* 按钮组样式 */
.btn-group .btn {
    margin: 0;
    border-radius: 12px !important;
}

.btn-group .btn:not(:last-child) {
    margin-right: 0;
}

.btn-group .btn:not(:first-child) {
    margin-left: 0;
}

/* 移动端按钮组优化 */
@media (max-width: 768px) {
    .btn-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }

    .btn-group .btn {
        margin: 0;
        width: 100%;
        font-size: 0.9rem;
    }
}

/* 响应式图片高度 */
@media (max-width: 576px) {
    .image-container img {
        max-height: 200px !important;
    }
}

@media (min-width: 577px) and (max-width: 768px) {
    .image-container img {
        max-height: 280px !important;
    }
}

@media (min-width: 769px) {
    .image-container img {
        max-height: 400px !important;
    }
}

@media (max-width: 768px) {
    .btn-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .btn-group .btn {
        margin: 0;
    }
}
</style>
{% endblock %}